<!doctype html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.9.7/d3.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style/style.css"/ >
    <script src="dist/all.js"></script>
  </head>

  <body>
    <div class="container">
      <div id="selector">
        <div class="note">
          <p>This page shows a rough sketch of a tool for analyzing pitcher and batter mechanics. In a real tool, the tool would show analyses based on multiple calibrated camera angles, yielding 3D models and accurate data of the mechanics.</p>
          <p>The real tool would also display results for every pitch thrown or batted against by every player.</p>
          <p>Pose estimation was performed using the CMU Perceptual Computing Lab's <a href='https://github.com/CMU-Perceptual-Computing-Lab/openpose' target='_new'>OpenPose</a> learning system.</p>
        </div>
        <p>Select a pitch below to analyze mechanics.</p>
        <div id="datasets"></div>
      </div>
      <div id="viewer" style="display:none">
        <div id="frameViewer"></div>
        <div id="frames"></div>
        <div id="framesSlider"></div>
        <div id="frameDate">[date]</div>
        <div id="frameInning">[inning]</div>
        <div id="frameCount">[count]</div>
        <div id="frameOpponentTeam">[opponentTeam]</div>
        <div id="framePlayerName">[playername]</div>
        <div id="frameOpponentName">[opponentname]</div>

        <div id="frameVelocity">[velocity]</div>
        <div id="framePitchType">[pitchtype]</div>
        <div id="frameSpinRate">[spinrate]</div>
        <div id="frameBreak">[break]</div>
        <div id="framePlayResult">[playresult]</div>
      </div>
    </div>

    <script>
      let datasets = menuDataset();
      MenuTables(datasets);

      function showDataSet(d) {

          d3.select("#selector")
            .style("display","none");

          d3.select("#viewer")
            .style("display","block");


          let svg = d3.select("#frameViewer")
            .append("svg")
            .attr("height",d.size.height)
            .attr("width",d.size.width)
            .style("border","1px solid black");

          let image = svg
            .append("image")
            .attr("xlink:href",d.path + "/0001.png")
            .attr("width",d.size.width)
            .attr("height",d.size.height);

          let circles = svg
            .selectAll("circles");

          d3.select("#framePlayerName")
            .html(d.name);


          d3.select("#frameOpponentName")
            .html(d.opponent_player);

          d3.select("#frameDate")
            .html(d.date);

          d3.select("#frameInning")
            .html(d.inning);

          d3.select("#frameCount")
            .html(d.count.balls + " - " + d.count.strikes);

          d3.select("#frameOpponentTeam")
            .html(d.opponent_team_name);

          d3.json(d.json)
            .then((data) => {
              console.log(data);
              let frameCount = data.length;


              let bones = {
                "MidHip":["RHip,LHip"],
                "LHip":["LKnee"],
                "LKnee":["LAnkle"],
                "LAnkle":["LHeel"],
                "LHeel":["LBigToe","LSmallToe"]
              };


              let links = d3.select("#frames")
                .data(data)
                .enter()
                .append("a")
                .text((d,i) => { return " "+  i +" "})
                .on('click',updateImage);


                updateImage(data[0]);


              let sliderSvg = d3.select("#framesSlider")
                .append("svg")
                .attr("width",500)
                .attr("height",200)
                .style("border","1px solid black");

              let slider = new ModelSlider({
                "where":sliderSvg,
                "coordinates":{"x":50,"y":50},
                "formatter":(x) => { return x.toFixed(0)},
                "domain":[1,90],
                "styles":{
                  "labelFontFill":"black",
                  "labelFontSize":"12pt",
                  "labelActiveFontSize":"14pt"
                },
                "size":{
                  "width":400,
                },
                "labelText":"Frame:",
                "callbacks":{
                  "change":(newValue) => {
                    let frame = Math.floor(newValue);
                    updateImage(data[frame]);
                  }
                }
              });


            });


          function updateImage(datum) {
            let swap = datum.image.split(".");
            let compressed = swap[0] + "-fs8." + swap[1];
            console.log(compressed);
            image
              .attr("xlink:href",d.path + "/" + compressed);

            svg.selectAll("circle")
              .remove();

            svg.selectAll("line")
              .remove();

            let bones = {
              "LWrist":["LElbow"],
              "LElbow":["LShoulder"],
              "LShoulder":["Neck"],
              "RWrist":["RElbow"],
              "RElbow":["RShoulder"],
              "RShoulder":["Neck"],
              "Neck":["MidHip"],
              "MidHip":["RHip","LHip"],
              "LHip":["LKnee"],
              "LKnee":["LAnkle"],
              "LAnkle":["LHeel"],
              "LHeel":["LBigToe","LSmallToe"],
              "RHip":["RKnee"],
              "RKnee":["RHeel"],
              "RAnkle":["RHeel"],
              "RHeel":["RBigToe","RSmallToe"]
            };

            Object.keys(bones).forEach((startBone) => {
              bones[startBone].forEach((endBone) => {

                let checkStart = datum.keypoints.filter((a) => { return a.name === startBone}).length > 0;
                let checkEnd = datum.keypoints.filter((a) =>{ return a.name === endBone}).length > 0;
                if(checkStart && checkEnd) {
                  let startCoords = datum.keypoints.filter((a) => { return a.name == startBone})[0].coords;
                  let endCoords = datum.keypoints.filter((a) => { return a.name == endBone})[0].coords;

                  svg.append("line")
                    .attr("x1",startCoords[0])
                    .attr("x2",endCoords[0])
                    .attr("y1",startCoords[1])
                    .attr("y2",endCoords[1])
                    .attr("stroke","orange")
                    .attr("stroke-width",3);
                }
              })
            });


            svg.selectAll("circle")
              .data(datum.keypoints)
              .enter()
              .append("circle")
              .attr("cx",(d) =>{  return d.coords[0]})
              .attr("cy",(d) =>{  return d.coords[1]})
              .attr("r",5)
              .attr("fill","yellow")
              .attr("stroke","black")
              .on('mouseover',(d) => { console.log(d.name); });

          }

      }

    </script>
  </body>

</html>
